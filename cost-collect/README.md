# cost-collect - CSP ë°ì´í„° ìˆ˜ì§‘ ëª¨ë“ˆ

NHN Cloudì™€ ê°™ì€ CSPì˜ ì¸ìŠ¤í„´ìŠ¤ ìƒíƒœë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ìˆ˜ì§‘í•˜ê³  ë¹„ìš© ë°ì´í„°ë¥¼ ìƒì„±í•˜ëŠ” ë…ë¦½ì ì¸ ë°ì´í„° ìˆ˜ì§‘ ëª¨ë“ˆì…ë‹ˆë‹¤.

## ğŸ“¡ ì£¼ìš” ê¸°ëŠ¥

- **ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì§‘**: NHN Cloud APIë¥¼ í†µí•œ ì¸ìŠ¤í„´ìŠ¤ ìƒíƒœ ì‹¤ì‹œê°„ ìˆ˜ì§‘
- **ìƒíƒœ ì¶”ì **: ì¸ìŠ¤í„´ìŠ¤ì˜ running/shutdown ì‹œê°„ ì •ë°€ ì¶”ì 
- **ì£¼ê¸°ì  ëª¨ë‹ˆí„°ë§**: ì‚¬ìš©ì ì •ì˜ ê°„ê²©ìœ¼ë¡œ ìë™ ë°ì´í„° ìˆ˜ì§‘
- **ë°ì´í„° ì €ì¥**: JSON í˜•íƒœë¡œ êµ¬ì¡°í™”ëœ ë°ì´í„° ì €ì¥
- **í• ì¸ ì •ì±… ê´€ë¦¬**: NHN Cloud í• ì¸ ì •ì±… ì •ë³´ ê´€ë¦¬

## ğŸš€ ë¹ ë¥¸ ì‹œì‘

### 1. ë¹Œë“œ

```bash
cd cost-collect
go build -o cost-collect main.go
```

### 2. ì„¤ì • í™•ì¸

```bash
# í˜„ì¬ ì„¤ì • í™•ì¸ (costcliì—ì„œ ì„¤ì •í•œ ì •ë³´ ì‚¬ìš©)
./cost-collect config show
```

### 3. ì¼íšŒì„± ë°ì´í„° ìˆ˜ì§‘

```bash
# ì¸ìŠ¤í„´ìŠ¤ ìƒíƒœë¥¼ í•œ ë²ˆ ìˆ˜ì§‘
./cost-collect once
```

### 4. ì§€ì†ì ì¸ ë°ì´í„° ìˆ˜ì§‘

```bash
# ê¸°ë³¸ ê°„ê²©(15ë¶„)ìœ¼ë¡œ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘
./cost-collect start

# ì‚¬ìš©ì ì •ì˜ ê°„ê²©(10ë¶„)ìœ¼ë¡œ ìˆ˜ì§‘
./cost-collect start --interval 10

# ë°ëª¬ ëª¨ë“œë¡œ ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
./cost-collect start --daemon
```

## ğŸ“‹ ì‚¬ìš©ë²•

### ë°ì´í„° ìˆ˜ì§‘

```bash
# ì¼íšŒì„± ìˆ˜ì§‘
./cost-collect once

# ì§€ì†ì ì¸ ìˆ˜ì§‘ ì‹œì‘ (Ctrl+Cë¡œ ì¤‘ì§€)
./cost-collect start

# ì‚¬ìš©ì ì •ì˜ ê°„ê²©ìœ¼ë¡œ ìˆ˜ì§‘ (ë¶„ ë‹¨ìœ„)
./cost-collect start --interval 30

# ë°ëª¬ ëª¨ë“œë¡œ ì‹¤í–‰
./cost-collect start --daemon
```

### ìˆ˜ì§‘ê¸° ìƒíƒœ í™•ì¸

```bash
# ìˆ˜ì§‘ê¸° ìƒíƒœ ë° í†µê³„ í™•ì¸
./cost-collect status
```

### ì„¤ì • ê´€ë¦¬

```bash
# í˜„ì¬ ì„¤ì • í‘œì‹œ
./cost-collect config show
```

## ğŸ”§ ëª…ë ¹ì–´ ì˜µì…˜

### ì „ì—­ ì˜µì…˜
- `-c, --config string`: ì„¤ì • íŒŒì¼ ê²½ë¡œ ì§€ì •
- `-h, --help`: ë„ì›€ë§ í‘œì‹œ

### start ëª…ë ¹ì–´
- `-i, --interval int`: ìˆ˜ì§‘ ê°„ê²© (ë¶„ ë‹¨ìœ„) [ê¸°ë³¸ê°’: ì„¤ì •íŒŒì¼ ê°’ ì‚¬ìš©]
- `-d, --daemon`: ë°ëª¬ ëª¨ë“œë¡œ ì‹¤í–‰

## ğŸ“„ ì˜ˆì‹œ ì¶œë ¥

### ì¼íšŒì„± ìˆ˜ì§‘ ê²°ê³¼

```
ë°ì´í„° ìˆ˜ì§‘ì„ ì‹œì‘í•©ë‹ˆë‹¤...
2025/08/20 13:59:06 ì¸ì¦ ì„±ê³µ. í† í° ë§Œë£Œ ì‹œê°„: 2025-08-20 16:59:06 +0000 UTC
2025/08/20 13:59:07 ì¸ìŠ¤í„´ìŠ¤ 25ê°œë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.
ë°ì´í„° ìˆ˜ì§‘ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (ì†Œìš”ì‹œê°„: 1.2s)
ìˆ˜ì§‘ëœ ì¸ìŠ¤í„´ìŠ¤: 25ê°œ
ì‹¤í–‰ ì¤‘: 12ê°œ, ì •ì§€: 13ê°œ
```

### ì§€ì†ì ì¸ ìˆ˜ì§‘ ì‹œì‘

```
ë°ì´í„° ìˆ˜ì§‘ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. (ê°„ê²©: 15ë¶„)
Ctrl+Cë¡œ ì¢…ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

2025/08/20 13:59:07 ì¸ìŠ¤í„´ìŠ¤ 25ê°œë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.
2025/08/20 14:14:07 ì¸ìŠ¤í„´ìŠ¤ 25ê°œë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.
2025/08/20 14:29:07 ì¸ìŠ¤í„´ìŠ¤ 25ê°œë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.
...
```

### ìˆ˜ì§‘ê¸° ìƒíƒœ

```
=== ë°ì´í„° ìˆ˜ì§‘ê¸° ìƒíƒœ ===
ë§ˆì§€ë§‰ ìˆ˜ì§‘: 2025-08-20 13:59:07
ì´ ì¸ìŠ¤í„´ìŠ¤: 25ê°œ
ì‹¤í–‰ ì¤‘: 12ê°œ
ì •ì§€ ìƒíƒœ: 13ê°œ
ì„¤ì •ëœ ìˆ˜ì§‘ ê°„ê²©: 15ë¶„
```

## ğŸ—ƒï¸ ìˆ˜ì§‘ ë°ì´í„° êµ¬ì¡°

### ì¸ìŠ¤í„´ìŠ¤ ìƒíƒœ ë°ì´í„° (instances.json)

```json
{
  "instances": {
    "instance-id": {
      "id": "instance-id",
      "name": "instance-name",
      "flavor_id": "flavor-id",
      "current_status": "ACTIVE",
      "current_power_state": 1,
      "created_at": "2025-08-01T10:00:00Z",
      "last_updated": "2025-08-20T13:59:07Z",
      "state_history": [
        {
          "timestamp": "2025-08-20T13:59:07Z",
          "status": "ACTIVE",
          "power_state": 1,
          "is_running": true
        }
      ],
      "running_periods": [
        {
          "start_time": "2025-08-01T10:00:00Z",
          "end_time": "2025-08-01T15:00:00Z",
          "duration_minutes": 300
        }
      ],
      "shutdown_periods": [
        {
          "start_time": "2025-08-01T15:00:00Z",
          "end_time": null,
          "duration_minutes": 480
        }
      ]
    }
  },
  "last_update": "2025-08-20T13:59:07Z",
  "version": "1.0.0"
}
```

### ê°€ê²© ì •ë³´ ë°ì´í„° (pricing.json)

```json
{
  "version": "1.0.0",
  "currency": "KRW",
  "flavor_pricing": {
    "flavor-id": {
      "flavor_id": "flavor-id",
      "name": "c2.m4",
      "vcpu": 2,
      "ram_mb": 4096,
      "disk_gb": 20,
      "hourly_rate": 150.0,
      "monthly_rate": 108000.0
    }
  },
  "discount_rules": [
    {
      "id": "nhn_shutdown_90day",
      "name": "NHN ì¸ìŠ¤í„´ìŠ¤ ì…§ë‹¤ìš´ 90ì¼ í• ì¸",
      "description": "ì¸ìŠ¤í„´ìŠ¤ ìƒì„± í›„ 90ì¼ ì´ë‚´ì— ì…§ë‹¤ìš´ ì‹œ 90% í• ì¸",
      "type": "shutdown",
      "discount_percent": 90.0,
      "conditions": [
        {
          "type": "instance_age_days",
          "operator": "<=",
          "value": 90
        }
      ],
      "enabled": true
    }
  ]
}
```

## ğŸ”— ê´€ë ¨ ë„êµ¬

ì´ ëª¨ë“ˆì—ì„œ ìˆ˜ì§‘í•œ ë°ì´í„°ëŠ” [costcli](../costcli/) ë„êµ¬ì—ì„œ ë¹„ìš© ê³„ì‚°ì— ì‚¬ìš©ë©ë‹ˆë‹¤.

**ë¹„ìš© ê³„ì‚°ì´ í•„ìš”í•œ ê²½ìš°:**
```bash
# ìƒìœ„ ë””ë ‰í† ë¦¬ì˜ costcli ì‚¬ìš©
cd ../costcli
./costcli calculate
```

## âš™ï¸ ì„¤ì • íŒŒì¼

cost-collectëŠ” costcliì™€ ë™ì¼í•œ ì„¤ì • íŒŒì¼(`~/.costctl/config.json`)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

**í•„ìˆ˜ ì„¤ì • í•­ëª©:**
- `nhn_cloud.tenant_id`: NHN Cloud í”„ë¡œì íŠ¸ ID
- `nhn_cloud.username`: NHN Cloud ì‚¬ìš©ìëª… (ì´ë©”ì¼)
- `nhn_cloud.password`: API ë¹„ë°€ë²ˆí˜¸

**ëª¨ë‹ˆí„°ë§ ì„¤ì • í•­ëª©:**
- `monitor.interval_minutes`: ìˆ˜ì§‘ ê°„ê²© (ë¶„) [ê¸°ë³¸ê°’: 15]

## ğŸ“Š ë°ì´í„° ì €ì¥ ìœ„ì¹˜

```
~/.costctl/
â”œâ”€â”€ config.json          # ì„¤ì • íŒŒì¼ (costcliì™€ ê³µìœ )
â””â”€â”€ data/
    â”œâ”€â”€ instances.json    # ì¸ìŠ¤í„´ìŠ¤ ìƒíƒœ ë°ì´í„° (ì´ ëª¨ë“ˆì—ì„œ ìƒì„±)
    â””â”€â”€ pricing.json      # ê°€ê²© ì •ë³´ ë° í• ì¸ ì •ì±… (ì´ ëª¨ë“ˆì—ì„œ ê´€ë¦¬)
```

## ğŸ”„ ì›Œí¬í”Œë¡œìš°

1. **ì„¤ì •**: costcliì—ì„œ `config init` ë° ì¸ì¦ ì •ë³´ ì„¤ì •
2. **ìˆ˜ì§‘**: cost-collectë¡œ ë°ì´í„° ìˆ˜ì§‘
3. **ë¶„ì„**: costclië¡œ ë¹„ìš© ê³„ì‚° ë° ë¶„ì„

## ğŸš¨ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ì¸ì¦ ì‹¤íŒ¨
- NHN Cloud ì¸ì¦ ì •ë³´ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”
- API ë¹„ë°€ë²ˆí˜¸ê°€ ê³„ì • ë¹„ë°€ë²ˆí˜¸ì™€ ë‹¤ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”
- í…Œë„ŒíŠ¸ IDê°€ ì •í™•í•œì§€ í™•ì¸í•˜ì„¸ìš”

### ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜
- ì¸í„°ë„· ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”
- NHN Cloud API ì„œë¹„ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”
- ë°©í™”ë²½ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”

### ì„¤ì • íŒŒì¼ ì˜¤ë¥˜
- `cost-collect config show`ë¡œ í˜„ì¬ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”
- costcliì—ì„œ `config init`ìœ¼ë¡œ ì„¤ì • íŒŒì¼ì„ ì¬ìƒì„±í•˜ì„¸ìš”

### ë°ì´í„° ì €ì¥ ì‹¤íŒ¨
- ë°ì´í„° ë””ë ‰í† ë¦¬ì— ì“°ê¸° ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”
- ë””ìŠ¤í¬ ê³µê°„ì´ ì¶©ë¶„í•œì§€ í™•ì¸í•˜ì„¸ìš”

## ğŸ“ˆ ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

- **ìˆ˜ì§‘ ê°„ê²©**: ë„ˆë¬´ ì§§ì€ ê°„ê²©ì€ API í˜¸ì¶œ ì œí•œì— ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤
- **ì¸ìŠ¤í„´ìŠ¤ ìˆ˜**: ëŒ€ëŸ‰ì˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆëŠ” ê²½ìš° ìˆ˜ì§‘ ì‹œê°„ì´ ê¸¸ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤
- **ë„¤íŠ¸ì›Œí¬**: ì•ˆì •ì ì¸ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤

## ğŸ“ ë¼ì´ì„ ìŠ¤

MIT License